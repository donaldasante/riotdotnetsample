# ASP.NET Core
# Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

name: 1.0$(Rev:.r)

parameters:
- name: buildConfig
  displayName: 'Build Config ?'
  type: string
  default: 'Debug'
  values:
  - 'Debug'
  - 'Release'
- name: image
  displayName: 'Pool Image ?'
  default: 'ubuntu-latest'
  values:
  - windows-latest
  - ubuntu-latest
  - macOS-latest

trigger:
- none

stages:
- stage: Build
  displayName: Build Package
  jobs:
    - job: buildNuget
      displayName: 'Build package'
      pool:
        vmImage: ${{parameters.image}}
      variables:
        buildConfiguration: ${{parameters.buildConfig}}
    
      steps:
      # Use latest 3.x sdk
      - task: UseDotNet@2
        displayName: 'Get latest dot net core 3.x'
        inputs:
          packageType: 'sdk'
          version: '3.x'

      # dotnet restore
      - task: DotNetCoreCLI@2
        displayName: 'dotnet restore'
        inputs:
          command: 'restore'
          projects: '$(Build.SourcesDirectory)/src/Templating.RiotSPA/Templating.RiotSPA.csproj'
          feedsToUse: 'select'
    
      # create nuget package
      - script: dotnet pack $(Build.SourcesDirectory)/src/Templating.RiotSPA/Templating.RiotSPA.csproj -o $(Build.ArtifactStagingDirectory) --no-build
        displayName: 'dotnet pack $(buildConfiguration)'
      
      # Publish nuget package
      - task: PublishBuildArtifacts@1
        displayName: 'Publish nuget package'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'

- stage: Deploy
  displayName: Deploy Package
  jobs:
    - job: deployNuget
      displayName: 'Deploy package to feed'
      pool:
        vmImage: ${{parameters.image}}
      variables:
        buildConfiguration: ${{parameters.buildConfig}}
        
      steps:
      # push to internal nuget feed if debug
      - ${{ if contains(parameters.buildConfig, 'Debug') }}:
        - task: NuGetCommand@2
          displayName: 'Push Nuget Package to internal feed'
          inputs:
            command: 'push'
            packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
            nuGetFeedType: 'internal'
            publishVstsFeed: 'd7c15b03-b716-41bd-9d61-4d01ca7d0c21/43af5651-da68-4b39-ae90-dd5ba3638a22'
            
      # Copy nuget package to feed
      - ${{ if contains(parameters.buildConfig, 'Release') }}:
        - task: DotNetCoreCLI@2
          displayName: 'Push Nuget Package to public nuget feed'
          inputs:
            command: custom
            custom: nuget
          arguments: >
            push $(Build.ArtifactStagingDirectory)/*.nupkg
            -s $(NuGetSourceServerUrl)
            -k $(NuGetSourceServerApiKey)
            dotnet nuget push --source "asanteit" --api-key az <package-path>